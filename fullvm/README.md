# Full VM in Docker

Use this to generate an Ubuntu full VM image for direct kernel booting. It's an alternative to the process shown [here](https://github.com/threefoldtech/zos/blob/main/docs/manual/zmachine/zmachine.md#vm), but done entirely in Docker containers.

To build an image, run the build script and pass the name of the folder. For example, to build the minimal image, do:

```
./build.sh ubuntu-minimal
```

The output is a compressed tar archive inside the given folder, which is ready for upload to [the Hub](https://hub.grid.tf/upload).

The build script will also leave a Docker image on your system with the same name. This image can be run in Docker for limited testing and debug, but since it's not actually started with `systemd` you won't get the full experience.

## Hacking

To make a new image, just copy one folder and make your customizations in the Dockerfile. Most changes should go in the heredoc'd script section (`RUN <<EOF`). 

Once you build the image, it's possible to use `docker run -it <image name> bash` to have a look around, but to actually test how the image runs as a VM, see the next section.
 
## Testing in QEMU

A fuller test can be done by running the output as a VM with QEMU. Some scripts are included to help with this, under `vm`. You'll need `qemu-system` and `qemu-img` installed for this part.

After running `build.sh`, run all three scripts:

```
cd vm
./seed.sh
./mk-img.sh ../ubuntu-minimal/ubuntu-minimal.tar.gz
mv ubuntu-minimal.qcow ubuntu-base.qcow
./run.sh
```

Wait for the VM to boot up and `cloud-init` to complete. After it states that the authorized keys are written, the VM should be accessible by SSH at localhost port 2222:

```
ssh -p 2222 root@localhost
```

From there, each subsequent execution of `run.sh` will create a fresh image from the base image, eliminating any artifacts generated by `cloud-init`.

It's not necessary to run `seed.sh` again, as long as the `seed.img` file is preserved and your SSH key has not changed.

The kernel and initrd will also be saved inside the folder. These are needed to boot the VM. Running `mk-img.sh` again will overwrite the kernel, initrd, and the VM image with the latest changes from the specified tar archive.

## Notes

* Using `debootstrap` inside a container is somewhat precarious. I found `minbase` to work more reliably than the default manifest
* `kvm` kernel is much leaner because drivers for physical hardware aren't needed in VM
* For some of the packages installed in the final image it's not obvious why they're needed
  * `binutils` provides `readelf`, which is required by `extract-vmlinux`
  * `lsb-release` is used by `cloud-init`
  * Without `libpam-systemd`, systemctl doesn't work properly
* Probably there are some things missing that users would expect to find (it's a rather minimal system)
